name: Fuwari-Typecho CI (Ultimate Fix)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'fuwari-typecho/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'fuwari-typecho/**'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, json
          coverage: none
          tools: composer:v2
      
      - name: Install dependencies
        run: |
          cd fuwari-typecho
          composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: List project files (debug)
        run: |
          cd fuwari-typecho
          echo "=== Project files ==="
          find . -type f -name "*.php" | grep -v vendor | head -20
          echo "=== Vendor files ==="
          find . -type f -name "*.php" | grep vendor | head -10
      
      - name: PHP syntax check (manual exclusion)
        run: |
          cd fuwari-typecho
          echo "Running PHP syntax check..."
          
          # Get all PHP files excluding vendor
          php_files=$(find . -type f -name "*.php" -not -path "*/vendor/*" -not -path "./vendor/*")
          
          # Check each file
          for file in $php_files; do
            php -l "$file"
          done
      
      - name: PHPCS with extreme exclusion
        run: |
          cd fuwari-typecho
          echo "Running PHPCS with extreme exclusion..."
          
          # Get all PHP files excluding vendor
          php_files=$(find . -type f -name "*.php" -not -path "*/vendor/*" -not -path "./vendor/*")
          
          # If we have files to check
          if [ -n "$php_files" ]; then
            # Run PHPCS with explicit file list
            vendor/bin/phpcs --standard=PSR12 --report-full $php_files
          else
            echo "No PHP files found to check (excluding vendor)"
          fi
      
      - name: PHPStan with strict paths
        run: |
          cd fuwari-typecho
          echo "Running PHPStan..."
          
          # Create minimal PHPStan config
          cat > phpstan.neon << 'EOF'
          parameters:
            level: 5
            paths:
              - .
            excludePaths:
              - vendor/*
              - node_modules/*
            ignoreErrors:
              - '#Call to function assert with string argument#'
              - '#Property.*has no type specified#'
          EOF
          
          vendor/bin/phpstan analyse --configuration=phpstan.neon
      
      - name: Create release package
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          cd fuwari-typecho
          VERSION=$(date +%Y%m%d).$(git rev-parse --short HEAD)
          echo "Creating release package v$VERSION..."
          
          # Create version info
          echo "Version: v$VERSION" > version.txt
          echo "Release Date: $(date)" >> version.txt
          echo "Commit: $(git rev-parse HEAD)" >> version.txt
          
          # Get project files for packaging
          project_files=$(find . -type f -not -path "*/vendor/*" -not -path "./vendor/*" -not -path "*/node_modules/*" -not -path "./node_modules/*")
          
          # Create zip package
          zip -r "../fuwari-typecho-v$VERSION.zip" $project_files version.txt
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ## Release v${{ github.run_number }}
            
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ### Changes:
            ${{ github.event.head_commit.message }}
          files: fuwari-typecho-v*.zip
          draft: false
          prerelease: false
