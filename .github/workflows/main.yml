name: Fuwari-Typecho CI (Fixed Vendor Detection)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'fuwari-typecho/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'fuwari-typecho/**'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, json
          coverage: none
          tools: composer:v2
      
      - name: Install dependencies
        run: |
          cd fuwari-typecho
          composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Create strict exclusion configurations
        run: |
          cd fuwari-typecho
          
          # Create project-specific PHPCS configuration
          cat > phpcs.xml << 'EOF'
          <?xml version="1.0"?>
          <ruleset name="Fuwari-Typecho">
            <description>Fuwari-Typecho coding standard with strict vendor exclusion</description>
            
            <!-- Only include our source files -->
            <file>src</file>
            <file>lib</file>
            <file>classes</file>
            <file>functions.php</file>
            <file>index.php</file>
            
            <!-- Explicitly exclude all vendor directories -->
            <exclude-pattern>*/vendor/*</exclude-pattern>
            <exclude-pattern>vendor/*</exclude-pattern>
            <exclude-pattern>*/node_modules/*</exclude-pattern>
            <exclude-pattern>node_modules/*</exclude-pattern>
            <exclude-pattern>*/tests/*</exclude-pattern>
            <exclude-pattern>tests/*</exclude-pattern>
            
            <!-- Use PSR-12 standard -->
            <rule ref="PSR12">
              <!-- Exclude rules that often conflict with static analysis tools -->
              <exclude name="Generic.Files.LineLength.TooLong" />
              <exclude name="Squiz.Functions.MultiLineFunctionDeclaration.BraceOnSameLine" />
              <exclude name="Squiz.Commenting.FunctionComment.MissingParamTag" />
              <exclude name="Squiz.Commenting.FunctionComment.MissingReturn" />
            </rule>
            
            <!-- Custom rules for Typecho themes/plugins -->
            <rule ref="Generic.PHP.DisallowShortOpenTag" />
            <rule ref="Generic.CodeAnalysis.UnusedFunctionParameter" />
          </ruleset>
          EOF
          
          # Create PHPStan configuration with strict paths
          cat > phpstan.neon << 'EOF'
          parameters:
            level: 5
            paths:
              - src
              - lib
              - classes
              - functions.php
              - index.php
            excludePaths:
              - vendor/*
              - node_modules/*
              - tests/*
            ignoreErrors:
              - '#Call to function assert with string argument#'
              - '#Property.*has no type specified#'
              - '#Method.*has no return type specified#'
          EOF
          
          # Create Psalm configuration
          cat > psalm.xml << 'EOF'
          <?xml version="1.0"?>
          <psalm
            errorLevel="5"
            resolveFromConfigFile="true"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns="https://getpsalm.org/schema/config"
            xsi:schemaLocation="https://getpsalm.org/schema/config vendor/vimeo/psalm/config.xsd"
          >
            <projectFiles>
              <directory name="src" />
              <directory name="lib" />
              <directory name="classes" />
              <file name="functions.php" />
              <file name="index.php" />
              <ignoreFiles>
                <directory name="vendor" />
                <directory name="node_modules" />
                <directory name="tests" />
              </ignoreFiles>
            </projectFiles>
          </psalm>
          EOF
      
      - name: PHP syntax check (only our files)
        run: |
          cd fuwari-typecho
          echo "Running PHP syntax check on project files only..."
          
          # Check specific directories
          for dir in src lib classes; do
            if [ -d "$dir" ]; then
              find "$dir" -name "*.php" -type f -print0 | xargs -0 -n1 php -l
            fi
          done
          
          # Check root files
          for file in functions.php index.php; do
            if [ -f "$file" ]; then
              php -l "$file"
            fi
          done
      
      - name: PHP CodeSniffer (strict exclusion)
        run: |
          cd fuwari-typecho
          echo "Running PHP CodeSniffer with strict vendor exclusion..."
          vendor/bin/phpcs --standard=phpcs.xml --report-full .
      
      - name: PHPStan static analysis
        run: |
          cd fuwari-typecho
          echo "Running PHPStan..."
          vendor/bin/phpstan analyse --configuration=phpstan.neon
      
      - name: Create release package
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          cd fuwari-typecho
          VERSION=$(date +%Y%m%d).$(git rev-parse --short HEAD)
          echo "Creating release package v$VERSION..."
          
          # Create version info
          echo "Version: v$VERSION" > version.txt
          echo "Release Date: $(date)" >> version.txt
          echo "Commit: $(git rev-parse HEAD)" >> version.txt
          
          # Create zip package (exclude vendor)
          zip -r "../fuwari-typecho-v$VERSION.zip" \
            src/ lib/ classes/ functions.php index.php version.txt \
            -x "*/vendor/*" -x "vendor/*" -x "*/node_modules/*" -x "node_modules/*"
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ## Release v${{ github.run_number }}
            
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ### Changes:
            ${{ github.event.head_commit.message }}
          files: fuwari-typecho-v*.zip
          draft: false
          prerelease: false
