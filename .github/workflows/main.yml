name: Fuwari-Typecho CI with Tool Compatibility

on:
  push:
    branches: [ main, master ]
    paths:
      - 'fuwari-typecho/**'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'fuwari-typecho/**'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, json
          coverage: none
          tools: composer:v2
      
      - name: Install dependencies
        run: |
          cd fuwari-typecho
          composer install --no-interaction --prefer-dist --optimize-autoloader
      
      - name: Create tool compatibility configurations
        run: |
          cd fuwari-typecho
          
          # PHPStan configuration with Psalm compatibility
          cat > phpstan.neon << 'EOF'
          parameters:
            level: 5
            paths:
              - .
            excludePaths:
              - vendor/*
              - node_modules/*
            ignoreErrors:
              - '#Psalm-specific type annotation#'
              - '#@psalm-#'
              - '#Callable array.*not allowed#'
              - '#Parameter.*with no value type specified#'
          EOF
          
          # Psalm configuration with PHPStan compatibility
          cat > psalm.xml << 'EOF'
          <?xml version="1.0"?>
          <psalm
            errorLevel="5"
            resolveFromConfigFile="true"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xmlns="https://getpsalm.org/schema/config"
            xsi:schemaLocation="https://getpsalm.org/schema/config vendor/vimeo/psalm/config.xsd"
          >
            <projectFiles>
              <directory name="." />
              <ignoreFiles>
                <directory name="vendor" />
                <directory name="node_modules" />
              </ignoreFiles>
            </projectFiles>
            <issueHandlers>
              <InvalidDocblock>
                <errorLevel type="suppress">
                  <directory name="vendor/phpstan" />
                  <directory name="vendor/squizlabs" />
                </errorLevel>
              </InvalidDocblock>
              <MissingClosureReturnType>
                <errorLevel type="suppress">
                  <directory name="vendor" />
                </errorLevel>
              </MissingClosureReturnType>
            </issueHandlers>
          </psalm>
          EOF
          
          # PHPCS configuration
          cat > phpcs.xml << 'EOF'
          <?xml version="1.0"?>
          <ruleset name="Fuwari-Typecho">
            <description>Fuwari-Typecho coding standard</description>
            
            <file>.</file>
            
            <exclude-pattern>vendor/*</exclude-pattern>
            <exclude-pattern>node_modules/*</exclude-pattern>
            
            <rule ref="PSR12">
              <exclude name="Generic.Files.LineLength.TooLong" />
              <exclude name="Squiz.Functions.MultiLineFunctionDeclaration.BraceOnSameLine" />
            </rule>
            
            <!-- Ignore tool-specific annotations -->
            <rule ref="Generic.PHP.DisallowShortOpenTag" />
            <rule ref="Generic.CodeAnalysis.UnusedFunctionParameter" />
          </ruleset>
          EOF
      
      - name: PHP syntax check
        run: |
          cd fuwari-typecho
          echo "Running PHP syntax check..."
          find . -name "*.php" -type f -not -path "*/vendor/*" -print0 | xargs -0 -n1 php -l
      
      - name: PHP CodeSniffer (PHPCS)
        run: |
          cd fuwari-typecho
          echo "Running PHP CodeSniffer..."
          vendor/bin/phpcs --standard=phpcs.xml .
      
      - name: PHPStan static analysis
        run: |
          cd fuwari-typecho
          echo "Running PHPStan..."
          vendor/bin/phpstan analyse --configuration=phpstan.neon .
      
      - name: Psalm static analysis
        run: |
          cd fuwari-typecho
          echo "Running Psalm..."
          vendor/bin/psalm --config=psalm.xml
      
      - name: Create release package
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        run: |
          cd fuwari-typecho
          VERSION=$(date +%Y%m%d).$(git rev-parse --short HEAD)
          echo "Creating release package v$VERSION..."
          
          # Create version info
          echo "Version: v$VERSION" > version.txt
          echo "Release Date: $(date)" >> version.txt
          echo "Commit: $(git rev-parse HEAD)" >> version.txt
          
          # Create zip package
          zip -r "../fuwari-typecho-v$VERSION.zip" ./* version.txt -x "vendor/*" -x "node_modules/*"
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          body: |
            ## Release v${{ github.run_number }}
            
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            **Commit:** ${{ github.sha }}
            
            ### Changes:
            ${{ github.event.head_commit.message }}
          files: fuwari-typecho-v*.zip
          draft: false
          prerelease: false
